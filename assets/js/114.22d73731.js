(window.webpackJsonp=window.webpackJsonp||[]).push([[114],{590:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("Boxx"),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#无状态负载-deployment"}},[s._v("无状态负载（Deployment）")]),a("ul",[a("li",[a("a",{attrs:{href:"#无状态负载-deployment"}},[s._v("无状态负载（Deployment）")])]),a("li",[a("a",{attrs:{href:"#创建deployment"}},[s._v("创建Deployment")])]),a("li",[a("a",{attrs:{href:"#deployment如何控制pod"}},[s._v("Deployment如何控制Pod")])]),a("li",[a("a",{attrs:{href:"#升级"}},[s._v("升级")])]),a("li",[a("a",{attrs:{href:"#回滚"}},[s._v("回滚")])])])]),a("li",[a("a",{attrs:{href:"#有状态负载-statefulset"}},[s._v("有状态负载（StatefulSet）")]),a("ul",[a("li",[a("a",{attrs:{href:"#有状态负载-statefulset"}},[s._v("有状态负载（StatefulSet）")])]),a("li",[a("a",{attrs:{href:"#创建headless-service"}},[s._v("创建Headless Service")])]),a("li",[a("a",{attrs:{href:"#创建statefulset"}},[s._v("创建Statefulset")])]),a("li",[a("a",{attrs:{href:"#statefulset的网络标识"}},[s._v("StatefulSet的网络标识")])]),a("li",[a("a",{attrs:{href:"#statefulset存储状态"}},[s._v("StatefulSet存储状态")])])])]),a("li",[a("a",{attrs:{href:"#普通任务-job-和定时任务-cronjob"}},[s._v("普通任务（Job）和定时任务（CronJob）")]),a("ul",[a("li",[a("a",{attrs:{href:"#普通任务-job-和定时任务-cronjob"}},[s._v("普通任务（Job）和定时任务（CronJob）")])]),a("li",[a("a",{attrs:{href:"#创建job"}},[s._v("创建Job")])]),a("li",[a("a",{attrs:{href:"#创建cronjob"}},[s._v("创建CronJob")])])])]),a("li",[a("a",{attrs:{href:"#守护进程集-daemonset"}},[s._v("守护进程集（DaemonSet）")]),a("ul",[a("li",[a("a",{attrs:{href:"#守护进程集-daemonset"}},[s._v("守护进程集（DaemonSet）")])]),a("li",[a("a",{attrs:{href:"#创建daemonset"}},[s._v("创建DaemonSet")])])])]),a("li",[a("a",{attrs:{href:"#亲和与反亲和调度"}},[s._v("亲和与反亲和调度")]),a("ul",[a("li",[a("a",{attrs:{href:"#node-affinity-节点亲和"}},[s._v("Node Affinity（节点亲和）")])]),a("li",[a("a",{attrs:{href:"#节点优先选择规则"}},[s._v("节点优先选择规则")])]),a("li",[a("a",{attrs:{href:"#工作负载亲和-podaffinity"}},[s._v("工作负载亲和（podAffinity）")])]),a("li",[a("a",{attrs:{href:"#工作负载反亲和-podantiaffinity"}},[s._v("工作负载反亲和（podAntiAffinity）")])])])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"无状态负载-deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#无状态负载-deployment"}},[s._v("#")]),s._v(" 无状态负载（Deployment）")]),s._v(" "),a("h4",{attrs:{id:"无状态负载-deployment-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#无状态负载-deployment-2"}},[s._v("#")]),s._v(" 无状态负载（Deployment）")]),s._v(" "),a("p",[s._v("Pod是Kubernetes创建或部署的最小单位，但是Pod是被设计为相对短暂的一次性实体，Pod可以被驱逐（当节点资源不足时）、随着集群的节点崩溃而消失。Kubernetes提供了Controller（控制器）来管理Pod，Controller可以创建和管理多个Pod，提供副本管理、滚动升级和自愈能力，其中最为常用的就是Deployment。")]),s._v(" "),a("p",[s._v("图1 Deployment")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/HCQvb0Fe3oS4kvxVFFncBnTSnbb.png",alt:""}})]),s._v(" "),a("p",[s._v("一个Deployment可以包含一个或多个Pod副本，每个Pod副本的角色相同，所以系统会自动为Deployment的多个Pod副本分发请求。")]),s._v(" "),a("p",[s._v("Deployment集成了上线部署、滚动升级、创建副本、恢复上线的功能，在某种程度上，Deployment实现无人值守的上线，大大降低了上线过程的复杂性和操作风险。")]),s._v(" "),a("h4",{attrs:{id:"创建deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建deployment"}},[s._v("#")]),s._v(" 创建Deployment")]),s._v(" "),a("p",[s._v("以下示例为创建一个名为nginx的Deployment负载，使用nginx:latest镜像创建两个Pod，每个Pod占用100m CPU、200Mi内存。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("apiVersion: apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("v1      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意这里与Pod的区别，Deployment是apps/v1而不是v1")]),s._v("\nkind: Deployment         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 资源类型为Deployment")]),s._v("\nmetadata:\n  name: nginx            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Deployment的名称")]),s._v("\nspec:\n  replicas: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod的数量，Deployment会确保一直有2个Pod运行         ")]),s._v("\n  selector:              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Label Selector")]),s._v("\n    matchLabels:      \n      app: nginx\n  template:              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod的定义，用于创建Pod，也称为Pod template")]),s._v("\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" image: nginx:latest\n        name: container"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        resources:\n          limits:\n            cpu: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("m\n            memory: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("Mi\n          requests:\n            cpu: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("m\n            memory: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("Mi\n      imagePullSecrets:\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("secret\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("从这个定义中可以看到Deployment的名称为nginx，spec.replicas定义了Pod的数量，即这个Deployment控制2个Pod；spec.selector是Label Selector（标签选择器），表示这个Deployment会选择Label为app=nginx的Pod；spec.template是Pod的定义，内容与Pod中的定义完全一致。")]),s._v(" "),a("p",[s._v("将上面Deployment的定义保存到deployment.yaml文件中，使用kubectl创建这个Deployment。")]),s._v(" "),a("p",[s._v("使用kubectl get查看Deployment和Pod，可以看到READY值为2/2，前一个2表示当前有2个Pod运行，后一个2表示期望有2个Pod，AVAILABLE为2表示有2个Pod是可用的。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f deployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\ndeployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx created\n\n$ kubectl get deploy\nNAME           READY     UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATE")]),s._v("   AVAILABLE   AGE\nnginx          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("m5s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"deployment如何控制pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployment如何控制pod"}},[s._v("#")]),s._v(" Deployment如何控制Pod")]),s._v(" "),a("p",[s._v("继续查询Pod，如下所示。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl get pods\nNAME                     READY     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tdmqk   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("s\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("txckx   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如果删掉一个Pod，您会发现立马会有一个新的Pod被创建出来，如下所示，这就是前面所说的Deployment会确保有2个Pod在运行，如果删掉一个，Deployment会重新创建一个，如果某个Pod故障或有其他问题，Deployment会自动拉起这个Pod。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delete")]),s._v(" pod nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("txckx\n\n$ kubectl get pods\nNAME                     READY     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tdmqk   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("s\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tesqr   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("看到有如下两个名为nginx-7f98958cdf-tdmqk和nginx-7f98958cdf-tesqr的Pod， 其中nginx是直接使用Deployment的名称，-7f98958cdf-tdmqk和-7f98958cdf-tesqr是kubernetes随机生成的后缀。")]),s._v(" "),a("p",[s._v("也许会发现这两个后缀中前面一部分是相同的，都是7f98958cdf，这是因为Deployment不是直接控制Pod的，Deployment是通过一种名为ReplicaSet的控制器控制Pod，通过如下命令可以查询ReplicaSet，其中rs是ReplicaSet的缩写。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl get rs\nNAME               DESIRED   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CURRENT")]),s._v("   READY     AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这个ReplicaSet的名称为nginx-7f98958cdf，后缀-7f98958cdf也是随机生成的。")]),s._v(" "),a("p",[s._v("Deployment控制Pod的方式如图所示，Deployment控制ReplicaSet，ReplicaSet控制Pod。")]),s._v(" "),a("p",[s._v("图2 Deployment通过ReplicaSet控制Pod")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/889E765C-F1C9-4D61-A680-1C593CF3AF65.png",alt:""}})]),s._v(" "),a("p",[s._v("如果使用kubectl describe命令查看Deployment的详情，就可以看到ReplicaSet，如下所示，可以看到有一行NewReplicaSet: nginx-7f98958cdf (2/2 replicas created)，而且Events里面事件确是把ReplicaSet的实例扩容到2个。在实际使用中您也许不会直接操作ReplicaSet，但了解Deployment通过控制ReplicaSet来控制Pod会有助于您定位问题。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("describe")]),s._v(" deploy nginx\nName:                   nginx\nNamespace:              "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v("\nCreationTimestamp:      Sun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Dec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0800")]),s._v("\nLabels:                 app"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\nNewReplicaSet:   nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" replicas created"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nEvents:\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Type")]),s._v("    Reason             Age   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("From")]),s._v("                   Message\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----    ------             ----  ----                   -------")]),s._v("\n  Normal  ScalingReplicaSet  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("m    deployment"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("controller  Scaled up replica "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h4",{attrs:{id:"升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级"}},[s._v("#")]),s._v(" 升级")]),s._v(" "),a("p",[s._v("在实际应用中，升级是一个常见的场景，Deployment能够很方便地支撑应用升级。")]),s._v(" "),a("p",[s._v("Deployment可以设置不同的升级策略，有如下两种。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("RollingUpdate：滚动升级，即逐步创建新Pod再删除旧Pod，为默认策略。")])]),s._v(" "),a("li",[a("p",[s._v("Recreate：替换升级，即先把当前Pod删掉再重新创建Pod。")])])]),s._v(" "),a("p",[s._v("Deployment的升级可以是声明式的，也就是说只需要修改Deployment的YAML定义即可，比如使用kubectl edit命令将上面Deployment中的镜像修改为nginx:alpine。修改完成后再查询ReplicaSet和Pod，发现创建了一个新的ReplicaSet，Pod也重新创建了。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl edit deploy nginx\n\n$ kubectl get rs\nNAME               DESIRED   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CURRENT")]),s._v("   READY     AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f9f58dffd   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("m\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f98958cdf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("m\n\n$ kubectl get pods\nNAME                     READY     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f9f58dffd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tdmqk   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("m\nnginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f9f58dffd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tesqr   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("Deployment可以通过maxSurge和maxUnavailable两个参数控制升级过程中同时重新创建Pod的比例，这在很多时候是非常有用，配置如下所示。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("spec:\n  strategy:\n    rollingUpdate:\n      maxSurge: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      maxUnavailable: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(": RollingUpdate\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("maxSurge：与Deployment中spec.replicas相比，可以有多少个Pod存在，默认值是25%，比如spec.replicas为 4，那升级过程中就不能超过5个Pod存在，即按1个的步伐升级，实际升级过程中会换算成数字，且换算会向上取整。这个值也可以直接设置成数字。")])]),s._v(" "),a("li",[a("p",[s._v("maxUnavailable：与Deployment中spec.replicas相比，可以有多少个Pod失效，也就是删除的比例，默认值是25%，比如spec.replicas为4，那升级过程中就至少有3个Pod存在，即删除Pod的步伐是1。同样这个值也可以设置成数字。")])])]),s._v(" "),a("p",[s._v("在前面的例子中，由于spec.replicas是2，如果maxSurge和maxUnavailable都为默认值25%，那实际升级过程中，maxSurge允许最多3个Pod存在（向上取整，2*1.25=2.5，取整为3），而maxUnavailable则不允许有Pod Unavailable（向上取整，2*0.75=1.5，取整为2），也就是说在升级过程中，一直会有2个Pod处于运行状态，每次新建一个Pod，等这个Pod创建成功后再删掉一个旧Pod，直至Pod全部为新Pod。")]),s._v(" "),a("h4",{attrs:{id:"回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回滚"}},[s._v("#")]),s._v(" 回滚")]),s._v(" "),a("p",[s._v("回滚也称为回退，即当发现升级出现问题时，让应用回到老的版本。Deployment可以非常方便地回滚到老版本。")]),s._v(" "),a("p",[s._v("例如上面升级的新版镜像有问题，可以执行kubectl rollout undo命令进行回滚。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl rollout undo deployment nginx\ndeployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx rolled back\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("Deployment之所以能如此容易的做到回滚，是因为Deployment是通过ReplicaSet控制Pod的，升级后之前ReplicaSet都一直存在，Deployment回滚做的就是使用之前的ReplicaSet再次把Pod创建出来。Deployment中保存ReplicaSet的数量可以使用revisionHistoryLimit参数限制，默认值为10。")]),s._v(" "),a("h2",{attrs:{id:"有状态负载-statefulset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有状态负载-statefulset"}},[s._v("#")]),s._v(" 有状态负载（StatefulSet）")]),s._v(" "),a("h4",{attrs:{id:"有状态负载-statefulset-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有状态负载-statefulset-2"}},[s._v("#")]),s._v(" 有状态负载（StatefulSet）")]),s._v(" "),a("p",[s._v("Deployment控制器下的Pod都有个共同特点，那就是每个Pod除了名称和IP地址不同，其余完全相同。需要的时候，Deployment可以通过Pod模板创建新的Pod；不需要的时候，Deployment就可以删除任意一个Pod。")]),s._v(" "),a("p",[s._v("但是在某些场景下，这并不满足需求，比如有些分布式的场景，要求每个Pod都有自己单独的状态时，比如分布式数据库，每个Pod要求有单独的存储，这时Deployment无法满足业务需求。")]),s._v(" "),a("p",[s._v("分布式有状态应用的特点主要是应用中每个部分的角色不同（即分工不同），比如数据库有主备、Pod之间有依赖，在Kubernetes中部署有状态应用对Pod有如下要求：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Pod能够被别的Pod找到，要求Pod有固定的标识。")])]),s._v(" "),a("li",[a("p",[s._v("每个Pod有单独存储，Pod被删除恢复后，必须读取原来的数据，否则状态就会不一致。")])])]),s._v(" "),a("p",[s._v("Kubernetes提供了StatefulSet来解决这个问题，其具体如下：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("StatefulSet给每个Pod提供固定名称，Pod名称增加从0-N的固定后缀，Pod重新调度后Pod名称和HostName不变。")])]),s._v(" "),a("li",[a("p",[s._v("StatefulSet通过Headless Service给每个Pod提供固定的访问域名。")])]),s._v(" "),a("li",[a("p",[s._v("StatefulSet通过创建固定标识的PVC保证Pod重新调度后还是能访问到相同的持久化数据。")])]),s._v(" "),a("li",[a("p",[s._v("图1 StatefulSet")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/WRXgb8vkwoK5moxH3c9cWHqzn4D.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"创建headless-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建headless-service"}},[s._v("#")]),s._v(" 创建Headless Service")]),s._v(" "),a("p",[s._v("如前所述，创建Statefulset需要一个"),a("a",{attrs:{href:"https://support.huaweicloud.com/basics-cce/kubernetes_0024.html#kubernetes_0024__section10301171915541",target:"_blank",rel:"noopener noreferrer"}},[s._v("Headless Service"),a("OutboundLink")],1),s._v("用于Pod访问。")]),s._v(" "),a("p",[s._v("使用如下文件描述Headless Service，其中：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("spec.clusterIP：必须设置为None，表示Headless Service。")])]),s._v(" "),a("li",[a("p",[s._v("spec.ports.port：Pod间通信端口号。")])]),s._v(" "),a("li",[a("p",[s._v("spec.ports.name：Pod间通信端口名称。")])])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对象类型为Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod间通信的端口名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod间通信的端口号")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 选择标签为app:nginx的Pod")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterIP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必须设置为None，表示Headless Service")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("执行如下命令创建Headless Service。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f headless.yaml ")]),s._v("\nservice/nginx created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("创建完成后可以查询Service。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc")]),s._v("\nNAME         TYPE        CLUSTER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("IP   EXTERNAL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("IP   PORT(S)   AGE\nnginx        ClusterIP   None         <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("        80/TCP    5s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"创建statefulset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建statefulset"}},[s._v("#")]),s._v(" 创建Statefulset")]),s._v(" "),a("p",[s._v("Statefulset的YAML定义与其他对象基本相同，主要有两个差异点：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("serviceName指定了Statefulset使用哪个Headless Service，需要填写Headless Service的名称。")])]),s._v(" "),a("li",[a("p",[s._v("volumeClaimTemplates是用来申请持久化声明PVC ，这里定义了一个名为data的模板，它会为每个Pod创建一个PVC，storageClassName指定了持久化存储的类型，在PV、PVC和StorageClass会详细介绍；volumeMounts是为Pod挂载存储。当然如果不需要存储的话可以删除volumeClaimTemplates和volumeMounts字段。")])])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StatefulSet\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# headless service的名称")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200Mi\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod挂载的存储")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  data            \n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  /usr/share/nginx/html     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储挂载到/usr/share/nginx/html")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeClaimTemplates")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data    \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      \n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteMany      \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        \n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1Gi      \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" csi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nas                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久化存储的类型")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("p",[s._v("执行如下命令创建。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f statefulset.yaml ")]),s._v("\nstatefulset.apps/nginx created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("命令执行后，查询一下StatefulSet和Pod，可以看到Pod的名称后缀从0开始到2，逐个递增。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get statefulset")]),s._v("\nNAME    READY   AGE\nnginx   3/3     107s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods")]),s._v("\nNAME      READY   STATUS    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("0   1/1     Running   0          112s\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1   1/1     Running   0          69s\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2   1/1     Running   0          39s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("此时如果手动删除nginx-1这个Pod，然后再次查询Pod，可以看到StatefulSet重新创建了一个名称相同的Pod，通过创建时间5s可以看出nginx-1是刚刚创建的。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete pod nginx-1")]),s._v('\npod "nginx'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('1" deleted\n\n'),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods")]),s._v("\nNAME      READY   STATUS    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("0   1/1     Running   0          3m4s\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1   1/1     Running   0          5s\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2   1/1     Running   0          1m10s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("进入容器查看容器的hostname，可以看到同样是nginx-0、nginx-1和nginx-2。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec nginx-0 -- sh -c 'hostname'")]),s._v("\nnginx-0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec nginx-1 -- sh -c 'hostname'")]),s._v("\nnginx-1\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec nginx-2 -- sh -c 'hostname'")]),s._v("\nnginx-2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("同时可以看一下StatefulSet创建的PVC，可以看到这些PVC，都以“PVC名称-StatefulSet名称-编号”的方式命名，并且处于Bound状态。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pvc")]),s._v("\nNAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\ndata-nginx-0   Bound    pvc-f58bc1a9-6a52-4664-a587-a9a1c904ba29   1Gi        RWX            csi-nas        2m24s\ndata-nginx-1   Bound    pvc-066e3a3a-fd65-4e65-87cd-6c3fd0ae6485   1Gi        RWX            csi-nas        101s\ndata-nginx-2   Bound    pvc-a18cf1ce-708b-4e94-af83-766007250b0c   1Gi        RWX            csi-nas        71s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"statefulset的网络标识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#statefulset的网络标识"}},[s._v("#")]),s._v(" StatefulSet的网络标识")]),s._v(" "),a("p",[s._v("StatefulSet创建后，可以看下Pod是有固定名称的，那Headless Service是如何起作用的呢，那就是使用DNS，为Pod提供固定的域名，这样Pod间就可以使用域名访问，即便Pod被重新创建而导致Pod的IP地址发生变化，这个域名也不会发生变化。")]),s._v(" "),a("p",[s._v("Headless Service创建后，每个Pod的IP都会有下面格式的域名。")]),s._v(" "),a("p",[s._v("<pod-name>.<svc-name>.<namespace>.svc.cluster.local")]),s._v(" "),a("p",[s._v("例如上面的三个Pod的域名就是：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("nginx-0.nginx.default.svc.cluster.local")])]),s._v(" "),a("li",[a("p",[s._v("nginx-1.nginx.default.svc.cluster.local")])]),s._v(" "),a("li",[a("p",[s._v("nginx-2.nginx.default.svc.cluster.local")])])]),s._v(" "),a("p",[s._v("实际访问时可以省略后面的.<namespace>.svc.cluster.local。")]),s._v(" "),a("p",[s._v("下面命令会使用tutum/dnsutils镜像创建一个Pod，进入这个Pod的容器，使用nslookup命令查看Pod对应的域名，可以发现能解析出Pod的IP地址。这里可以看到DNS服务器的地址是10.247.3.10，这是在创建CCE集群时默认安装CoreDNS插件，用于提供DNS服务，后续在Kubernetes网络会详细介绍CoreDNS的作用。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl run "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("i "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tty "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("image tutum/dnsutils dnsutils "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("restart=Never "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rm /bin/sh \nIf you don't see a command prompt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" try pressing enter.\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup nginx-0.nginx")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("         10.247.3.10\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        10.247.3.10"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("0.nginx.default.svc.cluster.local\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.16.0.31\n\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup nginx-1.nginx")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("         10.247.3.10\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        10.247.3.10"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1.nginx.default.svc.cluster.local\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.16.0.18\n\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup nginx-2.nginx")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("         10.247.3.10\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        10.247.3.10"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2.nginx.default.svc.cluster.local\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.16.0.19\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("此时如果手动删除这两个Pod，查询被StatefulSet重新创建的Pod的IP，然后使用nslookup命令解析Pod的域名，可以发现nginx-0.nginx和nginx-1.nginx仍然能解析到对应的Pod。这就保证了StatefulSet网络标识不变。")]),s._v(" "),a("h4",{attrs:{id:"statefulset存储状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#statefulset存储状态"}},[s._v("#")]),s._v(" StatefulSet存储状态")]),s._v(" "),a("p",[s._v("上面说了StatefulSet可以通过PVC做持久化存储，保证Pod重新调度后还是能访问到相同的持久化数据，在删除Pod时，PVC不会被删除。")]),s._v(" "),a("p",[s._v("图2 StatefulSet的Pod重建过程")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/D2oTb9XbwoC1ASxUZkdczXhHn6f.png",alt:""}})]),s._v(" "),a("p",[s._v("下面将通过实际操作验证这一点是如何做到的，执行下面的命令，在nginx-1的目录/usr/share/nginx/html中写入一些内容，例如将index.html的内容修改为“hello world”。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec nginx-1 -- sh -c 'echo hello world > /usr/share/nginx/html/index.html'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("修改完后，如果在Pod中访问“http://localhost”，那就会返回“hello world”。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it nginx-1 -- curl localhost")]),s._v("\nhello world\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("此时如果手动删除nginx-1这个Pod，然后再次查询Pod，可以看到StatefulSet重新创建了一个名称相同的Pod，通过创建时间4s可以看出nginx-1是刚刚创建的。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete pod nginx-1")]),s._v('\npod "nginx'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('1" deleted\n\n'),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods")]),s._v("\nNAME       READY   STATUS    RESTARTS   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("0    1/1     Running   0          14m\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1    1/1     Running   0          4s\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2    1/1     Running   0          13m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("再次访问该Pod的index.html页面，会发现仍然返回“hello world”，这说明这个Pod仍然是访问相同的存储。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it nginx-1 -- curl localhost")]),s._v("\nhello world\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"普通任务-job-和定时任务-cronjob"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#普通任务-job-和定时任务-cronjob"}},[s._v("#")]),s._v(" 普通任务（Job）和定时任务（CronJob）")]),s._v(" "),a("h4",{attrs:{id:"普通任务-job-和定时任务-cronjob-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#普通任务-job-和定时任务-cronjob-2"}},[s._v("#")]),s._v(" 普通任务（Job）和定时任务（CronJob）")]),s._v(" "),a("p",[s._v("Job和CronJob是负责批量处理短暂的一次性任务（short lived one-off tasks），即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Job：是Kubernetes用来控制批处理型任务的资源对象。批处理业务与长期伺服业务（Deployment、StatefulSet）的主要区别是批处理业务的运行有头有尾，而长期伺服业务在用户不停止的情况下永远运行。Job管理的Pod根据用户的设置把任务成功完成就自动退出（Pod自动删除）。")])]),s._v(" "),a("li",[a("p",[s._v("CronJob：是基于时间的Job，就类似于Linux系统的crontab文件中的一行，在指定的时间周期运行指定的Job。")])])]),s._v(" "),a("p",[s._v("任务负载的这种用完即停止的特性特别适合一次性任务，比如持续集成。")]),s._v(" "),a("h4",{attrs:{id:"创建job"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建job"}},[s._v("#")]),s._v(" 创建Job")]),s._v(" "),a("p",[s._v("以下是一个Job配置，其计算π到2000位并打印输出。Job结束需要运行50个Pod，这个示例中就是打印π 50次，并行运行5个Pod，Pod如果失败最多重试5次。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" batch/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Job\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("timeout\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("completions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行的次数，即Job结束需要成功运行的Pod个数")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("parallelism")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 并行运行Pod的数量，默认为1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("backoffLimit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示失败Pod的重试最大次数，超过这个次数不会继续重试。")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("activeDeadlineSeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示Pod超期时间，一旦达到这个时间，Job及其所有的Pod都会停止。")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod定义")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pi\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" perl\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" perl\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Mbignum=bpi"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-wle"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" print bpi(2000)\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Never\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("根据completions和parallelism的设置，可以将Job划分为以下几种类型。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[s._v("一次性Job")])]),s._v(" "),a("th",[a("strong",[s._v("创建一个Pod直至其成功结束")])]),s._v(" "),a("th",[a("strong",[s._v("数据库迁移")])])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("固定结束次数的Job")]),s._v(" "),a("td",[s._v("依次创建一个Pod运行直至completions个成功结束")]),s._v(" "),a("td",[s._v("处理工作队列的Pod")])]),s._v(" "),a("tr",[a("td",[s._v("固定结束次数的并行Job")]),s._v(" "),a("td",[s._v("依次创建多个Pod运行直至completions个成功结束")]),s._v(" "),a("td",[s._v("多个Pod同时处理工作队列")])]),s._v(" "),a("tr",[a("td",[s._v("并行Job")]),s._v(" "),a("td",[s._v("创建一个或多个Pod直至有一个成功结束")]),s._v(" "),a("td",[s._v("多个Pod同时处理工作队列")])])])]),s._v(" "),a("h4",{attrs:{id:"创建cronjob"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建cronjob"}},[s._v("#")]),s._v(" 创建CronJob")]),s._v(" "),a("p",[s._v("相比Job，CronJob就是一个加了定时的Job，CronJob执行时是在指定的时间创建出Job，然后由Job创建出Pod。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" batch/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" CronJob\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cronjob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("example\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("schedule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0,15,30,45 * * * *"')]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定时相关配置")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("jobTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Job的定义")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" OnFailure\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pi\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" perl\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" perl\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Mbignum=bpi"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-wle"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" print bpi(2000)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("CronJob的格式从前到后就是：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Minute")])]),s._v(" "),a("li",[a("p",[s._v("Hour")])]),s._v(" "),a("li",[a("p",[s._v("Day of month")])]),s._v(" "),a("li",[a("p",[s._v("Month")])]),s._v(" "),a("li",[a("p",[s._v("Day of week")])])]),s._v(" "),a("p",[s._v('如 "0,15,30,45 * * * * " ，前面逗号隔开的是分钟，后面第一个* 表示每小时，第二个 * 表示每个月的哪天，第三个表示每月，第四个表示每周的哪天。')]),s._v(" "),a("p",[s._v('如果您想要每个月的第一天里面每半个小时执行一次，那就可以设置为" 0,30 * 1 * * " 如果您想每个星期天的3am执行一次任务，那就可以设置为 "0 3 * * 0"。')]),s._v(" "),a("p",[s._v("更详细的CronJob格式说明请参见"),a("a",{attrs:{href:"https://zh.wikipedia.org/wiki/Cron",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://zh.wikipedia.org/wiki/Cron"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"守护进程集-daemonset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#守护进程集-daemonset"}},[s._v("#")]),s._v(" 守护进程集（DaemonSet）")]),s._v(" "),a("h4",{attrs:{id:"守护进程集-daemonset-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#守护进程集-daemonset-2"}},[s._v("#")]),s._v(" 守护进程集（DaemonSet）")]),s._v(" "),a("p",[s._v("DaemonSet（守护进程集）在集群的每个节点上运行一个Pod，且保证只有一个Pod，非常适合一些系统层面的应用，例如日志收集、资源监控等，这类应用需要每个节点都运行，且不需要太多实例，一个比较好的例子就是Kubernetes的kube-proxy。")]),s._v(" "),a("p",[s._v("DaemonSet跟节点相关，如果节点异常，也不会在其他节点重新创建。")]),s._v(" "),a("p",[s._v("图1 DaemonSet")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/UbtbbT2IooIKguxOwjTczXncnah.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"创建daemonset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建daemonset"}},[s._v("#")]),s._v(" 创建DaemonSet")]),s._v(" "),a("p",[s._v("下面是一个DaemonSet的示例。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DaemonSet\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点选择，当节点拥有daemon=need时才在节点上创建Pod")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("daemon")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" need\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 250m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 512Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 250m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 512Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("这里可以看出DaemonSet没有Deployment或StatefulSet中的replicas参数，因为DaemonSet会在每个目标节点上固定部署一个Pod。")]),s._v(" "),a("p",[s._v("Pod模板中有个nodeSelector，指定了只在有“daemon=need”的节点上才创建Pod，如下图所示，DaemonSet只在指定标签的节点上创建Pod。如果需要在每一个节点上创建Pod可以删除该标签。")]),s._v(" "),a("p",[s._v("图2 DaemonSet在指定标签的节点上创建Pod")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/CLQ5buAXYoJrZ9xtKHucE7S5nxf.png",alt:""}})]),s._v(" "),a("p",[s._v("创建DaemonSet：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f daemonset.yaml\ndaemonset.apps/nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查询发现nginx-daemonset没有Pod创建。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl get ds\nNAME              DESIRED   CURRENT   READY   UP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("TO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("DATE   AVAILABLE   NODE SELECTOR   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset   0         0         0       0            0           daemon=need     16s\n​\n$ kubectl get pods\nNo resources found in default namespace.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这是因为节点上没有daemon=need这个标签，使用如下命令可以查询节点的标签。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl get node "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("show"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("labels\nNAME            STATUS   ROLES    AGE   VERSION                            LABELS\n192.168.0.212   Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   83m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   beta.kubernetes.io/arch=amd64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n192.168.0.94    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   83m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   beta.kubernetes.io/arch=amd64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n192.168.0.97    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   83m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   beta.kubernetes.io/arch=amd64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("给192.168.0.212这个节点打上标签，然后再查询，发现已经创建了一个Pod，并且这个Pod是在192.168.0.212这个节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl label node 192.168.0.212 daemon=need\nnode/192.168.0.212 labeled\n\n$ kubectl get ds\nNAME              DESIRED   CURRENT   READY   UP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("TO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("DATE   AVAILABLE   NODE SELECTOR   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset   1         1         0       1            0           daemon=need     116s\n\n$ kubectl get pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                    READY   STATUS    RESTARTS   AGE   IP           NODE            \nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("g9b7j   1/1     Running   0          18s   172.16.3.0   192.168.0.212\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("再给192.168.0.94这个节点打上标签，发现又创建了一个Pod：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl label node 192.168.0.94 daemon=need\nnode/192.168.0.94 labeled\n\n$ kubectl get ds\nNAME              DESIRED   CURRENT   READY   UP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("TO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("DATE   AVAILABLE   NODE SELECTOR   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset   2         2         1       2            1           daemon=need     2m29s\n\n$ kubectl get pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                    READY   STATUS              RESTARTS   AGE   IP           NODE            \nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("6jjxz   0/1     ContainerCreating   0          8s    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("       192.168.0.94    \nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("g9b7j   1/1     Running             0          42s   172.16.3.0   192.168.0.212   \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("如果修改掉192.168.0.94节点的标签，可以发现DaemonSet会删除这个节点上的Pod。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl label node 192.168.0.94 daemon=no "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("overwrite\nnode/192.168.0.94 labeled\n\n$ kubectl get ds\nNAME              DESIRED   CURRENT   READY   UP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("TO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("DATE   AVAILABLE   NODE SELECTOR   AGE\nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset   1         1         1       1            1           daemon=need     4m5s\n\n$ kubectl get pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                    READY   STATUS    RESTARTS   AGE     IP           NODE            \nnginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("daemonset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("g9b7j   1/1     Running   0          2m23s   172.16.3.0   192.168.0.212\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"亲和与反亲和调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#亲和与反亲和调度"}},[s._v("#")]),s._v(" 亲和与反亲和调度")]),s._v(" "),a("p",[s._v("在守护进程集（DaemonSet）中讲到使用nodeSelector选择Pod要部署的节点，其实Kubernetes还支持更精细、更灵活的调度机制，那就是亲和（affinity）与反亲和（anti-affinity）调度。")]),s._v(" "),a("p",[s._v("Kubernetes支持节点和Pod两个层级的亲和与反亲和。通过配置亲和与反亲和规则，可以允许您指定硬性限制或者偏好，例如将前台Pod和后台Pod部署在一起、某类应用部署到某些特定的节点、不同应用部署到不同的节点等等。")]),s._v(" "),a("h4",{attrs:{id:"node-affinity-节点亲和"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-affinity-节点亲和"}},[s._v("#")]),s._v(" Node Affinity（节点亲和）")]),s._v(" "),a("p",[s._v("您肯定也猜到了亲和性规则的基础肯定也是标签，先来看一下CCE集群中节点上有些什么标签。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ kubectl describe "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.212\nName:               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.212\nRoles:              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nLabels:             beta.kubernetes.io/arch"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("amd64\n                    beta.kubernetes.io/os"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("linux\n                    failure-domain.beta.kubernetes.io/is-baremetal"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n                    failure-domain.beta.kubernetes.io/region"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cn-east-3\n                    failure-domain.beta.kubernetes.io/zone"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cn-east-3a\n                    kubernetes.io/arch"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("amd64\n                    kubernetes.io/availablezone"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cn-east-3a\n                    kubernetes.io/eniquota"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("\n                    kubernetes.io/hostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.212\n                    kubernetes.io/os"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("linux\n                    node.kubernetes.io/subnetid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("fd43acad-33e7-48b2-a85a-24833f362e0e\n                    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("os.architecture")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("amd64\n                    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("os.name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("EulerOS_2.0_SP5\n                    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("os.version")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-862.14.1.5.h328.eulerosv2r7.x86_64\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("这些标签都是在创建节点的时候CCE会自动添加上的，下面介绍几个在调度中会用到比较多的标签。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("failure-domain.beta.kubernetes.io/region：表示节点所在的区域，如果上面这个节点标签值为cn-east-3，表示节点在上海一区域。")])]),s._v(" "),a("li",[a("p",[s._v("failure-domain.beta.kubernetes.io/zone：表示节点所在的可用区（availability zone）。")])]),s._v(" "),a("li",[a("p",[s._v("kubernetes.io/hostname：节点的hostname。")])])]),s._v(" "),a("p",[s._v("另外在Label：组织Pod的利器章节还介绍自定义标签，通常情况下，对于一个大型Kubernetes集群，肯定会根据业务需要定义很多标签。")]),s._v(" "),a("p",[s._v("在守护进程集（DaemonSet）中介绍了nodeSelector，通过nodeSelector可以让Pod只部署在具有特定标签的节点上。如下所示，Pod只会部署在拥有gpu=true这个标签的节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点选择，当节点拥有gpu=true时才在节点上创建Pod")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("通过节点亲和性规则配置，也可以做到同样的事情，如下所示。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gpu\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        \n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requiredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("            \n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelectorTerms")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("            \n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("              \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gpu                \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In                \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("p",[s._v("看起来这要复杂很多，但这种方式可以得到更强的表达能力，后面会进一步介绍。")]),s._v(" "),a("p",[s._v("这里affinity表示亲和，nodeAffinity表示节点亲和，requiredDuringSchedulingIgnoredDuringExecution非常长，不过可以将这个分作两段来看：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("前半段requiredDuringScheduling表示下面定义的规则必须强制满足（require）才会调度Pod到节点上。")])]),s._v(" "),a("li",[a("p",[s._v("后半段IgnoredDuringExecution表示已经在节点上运行的Pod不需要满足下面定义的规则，即去除节点上的某个标签，那些需要节点包含该标签的Pod不会被重新调度。")])])]),s._v(" "),a("p",[s._v("另外操作符operator的值为In，表示标签值需要在values的列表中，其他operator取值如下。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("NotIn：标签的值不在某个列表中")])]),s._v(" "),a("li",[a("p",[s._v("Exists：某个标签存在")])]),s._v(" "),a("li",[a("p",[s._v("DoesNotExist：某个标签不存在")])]),s._v(" "),a("li",[a("p",[s._v("Gt：标签的值大于某个值（字符串比较）")])]),s._v(" "),a("li",[a("p",[s._v("Lt：标签的值小于某个值（字符串比较）")])])]),s._v(" "),a("p",[s._v("需要说明的是并没有nodeAntiAffinity（节点反亲和），因为NotIn和DoesNotExist可以提供相同的功能。")]),s._v(" "),a("p",[s._v("下面来验证这段规则是否生效，首先给192.168.0.212这个节点打上gpu=true的标签。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl label node 192.168.0.212 gpu=true\nnode/192.168.0.212 labeled\n\n$ kubectl get node "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("L gpu\nNAME            STATUS   ROLES    AGE   VERSION                            GPU\n192.168.0.212   Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   13m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   true\n192.168.0.94    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   13m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   \n192.168.0.97    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   13m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2    \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("创建这个Deployment，可以发现所有的Pod都部署在了192.168.0.212这个节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f affinity.yaml \ndeployment.apps/gpu created\n\n$ kubectl get pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                     READY   STATUS    RESTARTS   AGE   IP            NODE         \ngpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("6df65c44cf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("42xw4     1/1     Running   0          15s   172.16.0.37   192.168.0.212\ngpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("6df65c44cf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("jzjvs     1/1     Running   0          15s   172.16.0.36   192.168.0.212\ngpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("6df65c44cf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zv5cl     1/1     Running   0          15s   172.16.0.38   192.168.0.212\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"节点优先选择规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点优先选择规则"}},[s._v("#")]),s._v(" 节点优先选择规则")]),s._v(" "),a("p",[s._v("上面讲的requiredDuringSchedulingIgnoredDuringExecution是一种强制选择的规则，节点亲和还有一种优先选择规则，即preferredDuringSchedulingIgnoredDuringExecution，表示会根据规则优先选择哪些节点。")]),s._v(" "),a("p",[s._v("为演示这个效果，先为上面的集群添加一个节点，且这个节点跟另外三个节点不在同一个可用区，创建完之后查询节点的可用区标签，如下所示，新添加的节点在cn-east-3c这个可用区。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl get node "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("L failure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("domain.beta.kubernetes.io/zone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("gpu\nNAME            STATUS   ROLES    AGE     VERSION                            ZONE         GPU\n192.168.0.100   Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   7h23m   v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("east"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("3c   \n192.168.0.212   Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   8h      v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("east"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("3a   true\n192.168.0.94    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   8h      v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("east"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("3a   \n192.168.0.97    Ready    <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   8h      v1.15.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("20.3.0.2.B001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("15.30.2   cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("east"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("3a  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("下面定义一个Deployment，要求Pod优先部署在可用区cn-east-3a的节点上，可以像下面这样定义，使用preferredDuringSchedulingIgnoredDuringExecution规则，给cn-east-3a设置权重（weight）为80，而gpu=true权重为20，这样Pod就优先部署在cn-east-3a的节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gpu\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  gpu\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        \n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preferredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("             \n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preference")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               \n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" failure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("domain.beta.kubernetes.io/zone                \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In                 \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("east"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("3a          \n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("             \n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preference")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               \n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gpu                \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In                 \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("p",[s._v("来看实际部署后的情况，可以看到部署到192.168.0.212这个节点上的Pod有5个，而192.168.0.100上只有2个。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f affinity2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml \ndeployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("gpu created\n\n$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o wide\nNAME                   READY   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE     IP            NODE         \ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("bmcz   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".44")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cg2l6   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".63")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" \ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f2bt2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".79")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("hdb5n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".42")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("hkgvz   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".43")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("mngvn   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".48")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" \ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s26qs   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".62")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" \ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sxtzm   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".45")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t56cm   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".64")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("\ngpu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("585455")]),s._v("d466"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t5w5x   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m29s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".41")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("上面这个例子中，对于节点排序优先级如下所示，有两个标签的节点排序最高，只有cn-east-3a标签的节点排序第二（权重为80），只有gpu=true的节点排序第三，没有的节点排序最低。")]),s._v(" "),a("p",[s._v("图1 优先级排序顺序")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/E9iLbkO90o0rdFxUO8OcgFhenbX.png",alt:""}})]),s._v(" "),a("p",[s._v("这里您看到Pod并没有调度到192.168.0.94这个节点上，这是因为这个节点上部署了很多其他Pod，资源使用较多，所以并没有往这个节点上调度，这也侧面说明preferredDuringSchedulingIgnoredDuringExecution是优先规则，而不是强制规则。")]),s._v(" "),a("h4",{attrs:{id:"工作负载亲和-podaffinity"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作负载亲和-podaffinity"}},[s._v("#")]),s._v(" 工作负载亲和（podAffinity）")]),s._v(" "),a("p",[s._v("节点亲和的规则只能影响Pod和节点之间的亲和，Kubernetes还支持Pod和Pod之间的亲和，例如将应用的前端和后端部署在一起，从而减少访问延迟。Pod亲和同样有requiredDuringSchedulingIgnoredDuringExecution和preferredDuringSchedulingIgnoredDuringExecution两种规则。")]),s._v(" "),a("p",[a("strong",[s._v("说明：")])]),s._v(" "),a("p",[s._v("对于工作负载亲和来说，使用requiredDuringSchedulingIgnoredDuringExecution和preferredDuringSchedulingIgnoredDuringExecution规则时， topologyKey字段不允许为空。")]),s._v(" "),a("p",[s._v("来看下面这个例子，假设有个应用的后端已经创建，且带有app=backend的标签。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o wide\nNAME                       READY   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE     IP            NODE         \nbackend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("658")]),s._v("f6cb858"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dlrz8   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("m36s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".67")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("将前端frontend的pod部署在backend一起时，可以做如下Pod亲和规则配置。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("        \n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requiredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("          \n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologyKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/hostname            \n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("              \n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app                \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In                 \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" backend\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("p",[s._v("创建frontend然后查看，可以看到frontend都创建到跟backend一样的节点上了。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f affinity3.yaml \ndeployment.apps/frontend created\n\n$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP            NODE         \nbackend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("658f6cb858"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dlrz8    1/1     Running   0          5m38s   172.16.0.67   192.168.0.100\nfrontend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("67ff9b7b97"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dsqzn   1/1     Running   0          6s      172.16.0.70   192.168.0.100\nfrontend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("67ff9b7b97"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hxm5t   1/1     Running   0          6s      172.16.0.71   192.168.0.100\nfrontend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("67ff9b7b97"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("z8pdb   1/1     Running   0          6s      172.16.0.72   192.168.0.100\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("这里有个topologyKey字段（用于划分拓扑域），意思是先圈定topologyKey指定的范围，当节点上的标签键、值均相同时会被认为同一拓扑域，然后再选择下面规则定义的内容。这里每个节点上都有kubernetes.io/hostname，所以看不出topologyKey起到的作用。")]),s._v(" "),a("p",[s._v("如果backend有两个Pod，分别在不同的节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("o wide\nNAME                       READY   STATUS    RESTARTS   AGE     IP            NODE         \nbackend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("658f6cb858"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5bpd6   1/1     Running   0          23m     172.16.0.40   192.168.0.97\nbackend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("658f6cb858"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dlrz8   1/1     Running   0          2m36s   172.16.0.67   192.168.0.100\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("给192.168.0.97和192.168.0.94打上prefer=true的标签。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl label node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" prefer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nnode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" labeled\n$ kubectl label node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".94")]),s._v(" prefer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nnode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".94")]),s._v(" labeled\n\n$ kubectl get node "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("L prefer\nNAME            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("   ROLES    AGE   VERSION                            PREFER\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("m   v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("B001"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.30")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),s._v("   \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("m   v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("B001"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.30")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),s._v("   \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".94")]),s._v("    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("m   v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("B001"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.30")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v("    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("m   v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("B001"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.30")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".2")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("将podAffinity的topologyKey定义为prefer，则节点拓扑域的划分如图2所示。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requiredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologyKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prefer\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" backend\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("图2 拓扑域示意图")]),s._v(" "),a("p",[a("img",{attrs:{src:"/znote/img/devops/BRf0bepc8oUVV4xGKcFcZrcVnKc.png",alt:""}})]),s._v(" "),a("p",[s._v("调度时，会根据prefer标签划分节点拓扑域，本示例中192.168.0.97和192.168.0.94被划作同一拓扑域。如果当拓扑域中运行着app=backend的Pod，即使该拓扑域中并非所有节点均运行了app=backend的Pod（本例该拓扑域中仅192.168.0.97节点上存在app=backend的Pod），frontend同样会部署在此拓扑域中（这里的192.168.0.97或192.168.0.94）。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f affinity3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml \ndeployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("frontend created\n\n$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o wide\nNAME                        READY   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE     IP            NODE         \nbackend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("658")]),s._v("f6cb858"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("bpd6    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("m     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".40")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v("\nbackend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("658")]),s._v("f6cb858"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dlrz8    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("m38s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".67")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("ff9b7b97"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dsqzn   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("s      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".70")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("ff9b7b97"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("hxm5t   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("s      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".71")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("ff9b7b97"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("z8pdb   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("s      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".72")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"工作负载反亲和-podantiaffinity"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作负载反亲和-podantiaffinity"}},[s._v("#")]),s._v(" 工作负载反亲和（podAntiAffinity）")]),s._v(" "),a("p",[s._v("前面讲了Pod的亲和，通过亲和将Pod部署在一起，有时候需求却恰恰相反，需要将Pod分开部署，例如Pod之间部署在一起会影响性能的情况。")]),s._v(" "),a("p",[a("strong",[s._v("说明：")])]),s._v(" "),a("p",[s._v("对于工作负载反亲和来说，使用requiredDuringSchedulingIgnoredDuringExecution规则时， Kubernetes默认的准入控制器 LimitPodHardAntiAffinityTopology要求topologyKey字段只能是kubernetes.io/hostname。如果您希望使用其他定制拓扑逻辑，可以更改或者禁用该准入控制器。")]),s._v(" "),a("p",[s._v("下面例子中定义了反亲和规则，这个规则表示根据kubernetes.io/hostname标签划分节点拓扑域，且如果该拓扑域中的某个节点上已经存在带有app=frontend标签的Pod，那么拥有相同标签的Pod将不能被调度到该拓扑域内的其他节点上。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  frontend\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  100m\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  200Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("secret\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podAntiAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requiredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologyKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/hostname    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#节点拓扑域")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Pod标签匹配规则")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In \n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" frontend\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("p",[s._v("创建并查看部署效果，示例中根据kubernetes.io/hostname标签划分节点拓扑域，在拥有kubernetes.io/hostname标签的节点中，每个节点的标签值均不同，因此一个拓扑域中只有一个节点。当一个拓扑域中（此处为一个节点）已经存在frontend标签的Pod时，该拓扑域不会被继续调度具有相同标签的Pod。本例中只有4个节点，因此还有一个Pod处于Pending状态无法调度。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ kubectl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f affinity4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml \ndeployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("frontend created\n\n$ kubectl get po "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o wide\nNAME                        READY   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("    RESTARTS   AGE   IP            NODE         \nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f686d8d87"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("dlsc   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".76")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".100")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f686d8d87"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d6l8p   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Pending   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("s   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f686d8d87"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("hgcq2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".54")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".97")]),s._v(" \nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f686d8d87"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("q7cfq   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".47")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".212")]),s._v("\nfrontend"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("f686d8d87"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("xl8hx   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".23")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".94")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("Reward")],1)}),[],!1,null,null,null);a.default=e.exports}}]);