(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{536:function(a,t,e){"use strict";e.r(t);var s=e(4),r=Object(s.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("Boxx"),a._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#背景介绍"}},[a._v("背景介绍")])]),t("li",[t("a",{attrs:{href:"#问题现象与初步诊断"}},[a._v("问题现象与初步诊断")])]),t("li",[t("a",{attrs:{href:"#heap-dump-分析过程"}},[a._v("Heap Dump 分析过程")]),t("ul",[t("li",[t("a",{attrs:{href:"#_1-oom-线程源"}},[a._v("1. OOM 线程源")])]),t("li",[t("a",{attrs:{href:"#_2-大量-byte-堆积"}},[a._v("2. 大量 `byte[]` 堆积")])]),t("li",[t("a",{attrs:{href:"#_3-gc-root-引用链指向-skywalking"}},[a._v("3. GC Root 引用链指向 SkyWalking")])])])]),t("li",[t("a",{attrs:{href:"#skywalking-agent-配置审查"}},[a._v("SkyWalking Agent 配置审查")])]),t("li",[t("a",{attrs:{href:"#最终根因"}},[a._v("最终根因")])]),t("li",[t("a",{attrs:{href:"#解决方案与优化建议"}},[a._v("解决方案与优化建议")])]),t("li",[t("a",{attrs:{href:"#经验总结"}},[a._v("经验总结")])]),t("li",[t("a",{attrs:{href:"#附录"}},[a._v("附录")]),t("ul",[t("li",[t("a",{attrs:{href:"#jvm-启动参数建议"}},[a._v("JVM 启动参数建议：")])]),t("li",[t("a",{attrs:{href:"#分析工具推荐"}},[a._v("分析工具推荐")])])])]),t("li",[t("a",{attrs:{href:"#最后"}},[a._v("最后")])])])]),t("p"),a._v(" "),t("h2",{attrs:{id:"背景介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景介绍"}},[a._v("#")]),a._v(" 背景介绍")]),a._v(" "),t("p",[a._v("在一次压测过程中，我们部署在生产环境中的 "),t("strong",[a._v("Spring Cloud Gateway")]),a._v(" 出现了频繁宕机，表现为：")]),a._v(" "),t("ul",[t("li",[a._v("请求响应超时")]),a._v(" "),t("li",[a._v("容器意外重启")]),a._v(" "),t("li",[a._v("无明显异常堆栈输出")]),a._v(" "),t("li",[a._v("日志记录不完整甚至缺失")])]),a._v(" "),t("p",[a._v("初步怀疑为内存泄漏或 JVM 配置问题，随即启动一轮完整的排查流程。")]),a._v(" "),t("blockquote",[t("p",[a._v("服务已开启 "),t("a",{attrs:{href:"https://skywalking.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Apache SkyWalking"),t("OutboundLink")],1),a._v(" Agent，用于采集链路追踪、JVM 指标与应用日志。由于宕机频繁，决定深入定位 "),t("strong",[a._v("是否存在内存泄漏")]),a._v("。")])]),a._v(" "),t("h2",{attrs:{id:"问题现象与初步诊断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题现象与初步诊断"}},[a._v("#")]),a._v(" 问题现象与初步诊断")]),a._v(" "),t("p",[t("strong",[a._v("现象：")])]),a._v(" "),t("ul",[t("li",[t("p",[a._v("Gateway 应用启动参数初始为  "),t("code",[a._v("-Xmx512m")]),a._v(" 后又增加到 "),t("code",[a._v("-Xmx1024m")])])]),a._v(" "),t("li",[t("p",[a._v("容器在高并发压测约 15 分钟内异常退出")])]),a._v(" "),t("li",[t("p",[t("code",[a._v('docker inspect dky-gateway | grep -i "oom"')]),a._v(" 显示 "),t("code",[a._v("OOMKilled=false")]),a._v("，说明并非容器外部 OOM Killer 所致")])]),a._v(" "),t("li",[t("p",[a._v("随后使用 "),t("code",[a._v("top")]),a._v(" 查看 Java 进程内存和 CPU 使用情况：")]),a._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Xmx1024m")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\nRES "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(".3g\nCPU "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("500")]),a._v("%+\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("均显示内存快速增长至近 1.3GB，超出了 "),t("code",[a._v("-Xmx1024m")]),a._v(" 限制，极有可能是 JVM 内存泄漏。")])])]),a._v(" "),t("p",[t("strong",[a._v("初步排查方向：")])]),a._v(" "),t("ul",[t("li",[t("p",[a._v("GC 日志未显示 FullGC")])]),a._v(" "),t("li",[t("p",[a._v("未检测到容器外部 OOM 杀死痕迹")])]),a._v(" "),t("li",[t("p",[a._v("怀疑为应用内部内存泄漏，故手动生成 Heap Dump ("),t("code",[a._v(".hprof")]),a._v(") 文件")]),a._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("jcmd "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("PID"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" GC.heap_dump /home/logs/gateway.hprof\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])])]),a._v(" "),t("h2",{attrs:{id:"heap-dump-分析过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#heap-dump-分析过程"}},[a._v("#")]),a._v(" Heap Dump 分析过程")]),a._v(" "),t("p",[a._v("使用 VisualVM 载入 "),t("code",[a._v(".hprof")]),a._v(" 文件后，发现以下核心问题：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/znote/img/backend/image-20250609171844186.png",alt:"image-20250609171844186.png"}})]),a._v(" "),t("h3",{attrs:{id:"_1-oom-线程源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-oom-线程源"}},[a._v("#")]),a._v(" 1. OOM 线程源")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('"SkywalkingAgent-10-ProfileSendSnapshotService-0" daemon tid=13 RUNNABLE\n')])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("这是 SkyWalking 的 profile 功能线程，负责收集 trace 样本并发送快照 → "),t("strong",[a._v("高度可疑是内存泄漏/积压点")]),a._v("。")]),a._v(" "),t("h3",{attrs:{id:"_2-大量-byte-堆积"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-大量-byte-堆积"}},[a._v("#")]),a._v(" 2. "),t("strong",[a._v("大量 "),t("code",[a._v("byte[]")]),a._v(" 堆积")])]),a._v(" "),t("ul",[t("li",[a._v("占用内存："),t("strong",[a._v("422MB")]),a._v("（55.3%）")]),a._v(" "),t("li",[a._v("实例数：9.3 万")]),a._v(" "),t("li",[a._v("全部 retained：说明未被 GC 回收")])]),a._v(" "),t("h3",{attrs:{id:"_3-gc-root-引用链指向-skywalking"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-gc-root-引用链指向-skywalking"}},[a._v("#")]),a._v(" 3. "),t("strong",[a._v("GC Root 引用链指向 SkyWalking")])]),a._v(" "),t("p",[a._v("我们点击某个 "),t("code",[a._v("byte[]")]),a._v(" 实例查看引用链：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/znote/img/backend/image-20250609171742530.png",alt:"image-20250609171742530.png"}})]),a._v(" "),t("div",{staticClass:"language-less line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-less"}},[t("code",[a._v("sun.nio.ch.EPollArrayWrapper#eventsLow [GC root "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v(" Java frame]\n  └── sun.nio.ch.EPollSelectorImpl#pollWrapper\n      └── org.apache.skywalking.apm.dependencies.io.netty.channel.nio.NioEventLoop#unwrappedSelector\n          └── byte[]\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("即："),t("strong",[a._v("SkyWalking Agent 内部使用的 Netty Selector 事件缓冲未释放，导致内存持续增长，最终触发 OOM")]),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"skywalking-agent-配置审查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#skywalking-agent-配置审查"}},[a._v("#")]),a._v(" SkyWalking Agent 配置审查")]),a._v(" "),t("p",[a._v("在分析其 "),t("code",[a._v("agent.config")]),a._v(" 后确认：")]),a._v(" "),t("ul",[t("li",[a._v("开启了 "),t("code",[a._v("profile.active=true")]),a._v(" → Profile 快照任务占用大量内存")]),a._v(" "),t("li",[a._v("默认开启 trace 采样 "),t("code",[a._v("agent.sample_n_per_3_secs=-1")])]),a._v(" "),t("li",[a._v("未设置 "),t("code",[a._v("keep_tracing=false")]),a._v("，OAP 不可用时依然缓存数据")]),a._v(" "),t("li",[a._v("未关闭 "),t("code",[a._v("meter.active=false")]),a._v("，采集 JVM 指标增加内存压力")])]),a._v(" "),t("p",[a._v("这些配置会在 OAP 不可用或发送失败时，导致大量 trace 数据堆积在本地缓存（HeapByteBuffer、byte[]）。")]),a._v(" "),t("h2",{attrs:{id:"最终根因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最终根因"}},[a._v("#")]),a._v(" 最终根因")]),a._v(" "),t("p",[a._v("SkyWalking Agent 在开启 profile 功能 + 默认 trace 采样条件下，因连接不上 OAP 或处理不及时，造成 Netty Selector 中的数据缓冲无法及时清空，导致：")]),a._v(" "),t("ul",[t("li",[a._v("堆内 "),t("code",[a._v("byte[]")]),a._v(" 长期占用无法回收")]),a._v(" "),t("li",[a._v("堆内缓冲体积随压测剧增")]),a._v(" "),t("li",[a._v("最终触发 OOM")])]),a._v(" "),t("h2",{attrs:{id:"解决方案与优化建议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案与优化建议"}},[a._v("#")]),a._v(" 解决方案与优化建议")]),a._v(" "),t("p",[a._v("将如下配置写入 "),t("code",[a._v("agent.config")]),a._v("，并重启服务：")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("profile.active")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false                   # 禁用 profile 模块（强烈建议）")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("agent.sample_n_per_3_secs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0            # 关闭 trace 采样")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("agent.keep_tracing")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false               # 断开后不缓存 trace")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("agent.span_limit_per_segment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("50        # 限制 trace 单体大小")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("meter.active")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("false                     # 关闭 JVM 指标采集（视情况）")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("或使用环境变量注入：")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" SW_AGENT_SAMPLE=0\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" SW_AGENT_PROFILE_ACTIVE=false\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" SW_AGENT_KEEP_TRACING=false\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" SW_AGENT_SPAN_LIMIT=50\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" SW_METER_ACTIVE=false\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("ul",[t("li",[a._v("SkyWalking Agent 应根据实际 OAP 状态决定缓存策略")]),a._v(" "),t("li",[a._v("监控工具建议提供缓冲区限流能力，防止泄漏")]),a._v(" "),t("li",[a._v("建议开启 GC 日志和 "),t("code",[a._v("-XX:+HeapDumpOnOutOfMemoryError")]),a._v("，便于快速定位问题")])]),a._v(" "),t("h2",{attrs:{id:"经验总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#经验总结"}},[a._v("#")]),a._v(" 经验总结")]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("教训")]),a._v(" "),t("th",[a._v("内容")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("☠️ 默认配置风险")]),a._v(" "),t("td",[a._v("SkyWalking 默认开启 Profile/Trace 功能，在无 OAP 的场景下可能严重泄漏内存")])]),a._v(" "),t("tr",[t("td",[a._v("🔍 可观测性 ≠ 稳定性")]),a._v(" "),t("td",[a._v("即使是监控工具，也可能因配置不当拖垮核心业务")])]),a._v(" "),t("tr",[t("td",[a._v("💡 持续监控 agent 资源占用")]),a._v(" "),t("td",[a._v("使用 jstat、jmap、VisualVM 等工具进行定期回顾")])]),a._v(" "),t("tr",[t("td",[a._v("🧹 保持配置精简")]),a._v(" "),t("td",[a._v("监控在生产环境中建议关闭无必要的特性（如 profile）")])])])]),a._v(" "),t("ul",[t("li",[a._v("SkyWalking agent 在开启 profile 功能时，会通过 Netty 启动后台线程维护连接")]),a._v(" "),t("li",[a._v("若连接失败或网络不通，trace 数据会缓存在堆内 → "),t("strong",[a._v("潜在高风险")])]),a._v(" "),t("li",[a._v("内存泄漏不等于对象无用，而是“"),t("strong",[a._v("对象有用但永远不会释放")]),a._v("”")])]),a._v(" "),t("h2",{attrs:{id:"附录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#附录"}},[a._v("#")]),a._v(" 附录")]),a._v(" "),t("h3",{attrs:{id:"jvm-启动参数建议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jvm-启动参数建议"}},[a._v("#")]),a._v(" JVM 启动参数建议：")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Xmx1024m")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-XX:+HeapDumpOnOutOfMemoryError")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-XX:HeapDumpPath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/logs\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-XX:+ExitOnOutOfMemoryError")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-XX:+PrintGCDetails")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-XX:+PrintGCDateStamps")]),a._v("\n-Xloggc:/logs/gc.log\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])]),t("h3",{attrs:{id:"分析工具推荐"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分析工具推荐"}},[a._v("#")]),a._v(" 分析工具推荐")]),a._v(" "),t("ul",[t("li",[a._v("Heap Dump 分析：VisualVM / Eclipse MAT")]),a._v(" "),t("li",[a._v("实时监控：jstat, jstack, jcmd")]),a._v(" "),t("li",[a._v("容器层日志查看："),t("code",[a._v("docker logs")]),a._v(", "),t("code",[a._v("docker inspect")])])]),a._v(" "),t("h2",{attrs:{id:"最后"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[a._v("#")]),a._v(" 最后")]),a._v(" "),t("p",[a._v("这次事故为我们敲响了一个警钟："),t("strong",[a._v("即使是成熟的探针工具，在未正确配置下也可能带来灾难性后果")]),a._v("。\n务必做到： “"),t("strong",[a._v("监控自身也需被监控，稳定性永远优先于可观察性")]),a._v("。”")]),a._v(" "),t("Reward")],1)}),[],!1,null,null,null);t.default=r.exports}}]);